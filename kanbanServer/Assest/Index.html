<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<link rel="stylesheet"  href="Assest/Styles.css" type="text/css"/>-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css" integrity="sha256-XoaMnoYC5TH6/+ihMEnospgm0J1PM/nioxbOUdnM8HY=" crossorigin="anonymous">
    <title>Tablero Kanban</title>
    <style>

        * {
            border: 0;
            margin: 0;
        }
        /* Index */

        header {
            width: 100%;
            background: #007bff;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            position: fixed;
            top: 0;
            /* left: 0; */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .desplegable {
            display: flex;
            gap: 10px;
        }

            .desplegable a {
                color: white;
                text-decoration: none;
                padding: 4px;
            }

        h3 {
            text-align: center;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
            overflow: hidden; /* Evita el scroll */
            margin: 0;
        }

        .kanban {
            display: flex;
            gap: 20px;
        }

        .column {
            background: white;
            padding: 10px;
            width: 200px;
            height: 75vh;
            min-height: 300px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .task {
            background: #e3e3e3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            cursor: grab;
            display: grid;
            justify-content: space-between;
            position: relative;
        }

            .task h4, .task h6, .task p {
                padding: 2px;
            }

            .task p {
                font-size: 0.8rem;
            }

            .task a {
                text-decoration: none;
                display: flex;
                justify-content: end;
                font-size: 1rem;
                position: absolute;
                right: 0;
                bottom: 0;
                padding: 5px;
                color: #000;
            }

                .task a:hover {
                    color: #007bff;
                }

        .fa .fa-pencil-square-o {
            font-size: 1rem;
            color: #000;
        }

        .add {
            position: absolute;
            /* bottom: 2vh;
                    right: 2vh; */
            right: 4vh;
            bottom: 4vh;
            background: #007bff;
            color: white;
            font-size: 24px;
            text-decoration: none;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-self: end;
            align-items: center;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /*add-edit*/
        .card {
            background-color: #e3e3e3;
            /* width:70vw;
        height: 50vh; */
            border-radius: 10px;
            display: grid;
            padding: 20px;
            /* text-align: center; */
            align-items: center;
        }

            .card p {
                padding: 5px;
                font-size: 1.2rem;
                color: #000;
            }

            .card input {
                padding: 5px;
                margin: 10px;
            }

        .buttons {
            display: flex;
            justify-content: center;
        }

        button {
            width: 20vw;
            border-radius: 5px;
            margin: 10px;
            padding: 5px;
            cursor: pointer;
        }

            button:last-of-type {
                background-color: #007bff;
            }

        /*.eliminar {
            background: rgb(250, 54, 54);
        }*/
        /*login*/
        .login {
            display: grid;
            align-items: center;
            /* height: 50vh;
            width: 40vw; */
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            padding: 20px;
        }

            .login input {
                padding: 5px;
                margin: 10px;
            }

            .login h2 {
                text-align: center;
            }

            .login label {
                padding: 10px;
                font-size: 1.1rem;
            }

            .login button {
                width: 20vw;
                margin: 10px;
                padding: 5px;
                background-color: #0061c9;
                color: white;
            }

        * {
            border: 0;
            margin: 0;
        }
        /* Index */

        header {
            width: 100%;
            background: #007bff;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            position: fixed;
            top: 0;
            /* left: 0; */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .desplegable {
            display: flex;
            gap: 10px;
        }

            .desplegable a {
                color: white;
                text-decoration: none;
                padding: 4px;
            }

        h3 {
            text-align: center;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
            overflow: hidden; /* Evita el scroll */
            margin: 0;
        }

        .kanban {
            display: flex;
            gap: 20px;
        }

        .column {
            background: white;
            padding: 10px;
            width: 200px;
            height: 75vh;
            min-height: 300px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .task {
            background: #e3e3e3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            cursor: grab;
            display: grid;
            justify-content: space-between;
            position: relative;
        }

            .task h4, .task h6, .task p {
                padding: 2px;
            }

            .task p {
                font-size: 0.8rem;
            }

            .task a {
                text-decoration: none;
                display: flex;
                justify-content: end;
                font-size: 1rem;
                position: absolute;
                right: 0;
                bottom: 0;
                padding: 5px;
                color: #000;
            }

                .task a:hover {
                    color: #007bff;
                }

        .fa .fa-pencil-square-o {
            font-size: 1rem;
            color: #000;
        }

        .add {
            position: absolute;
            /* bottom: 2vh;
                    right: 2vh; */
            right: 4vh;
            bottom: 4vh;
            background: #007bff;
            color: white;
            font-size: 24px;
            text-decoration: none;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-self: end;
            align-items: center;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /*add-edit*/
        .card {
            background-color: #e3e3e3;
            /* width:70vw;
        height: 50vh; */
            border-radius: 10px;
            display: grid;
            padding: 20px;
            /* text-align: center; */
            align-items: center;
        }

            .card p {
                padding: 5px;
                font-size: 1.2rem;
                color: #000;
            }

            .card input {
                padding: 5px;
                margin: 10px;
            }

        .buttons {
            display: flex;
            justify-content: center;
        }

        button {
            width: 20vw;
            border-radius: 5px;
            margin: 10px;
            padding: 5px;
            cursor: pointer;
        }

            button:last-of-type {
                background-color: #007bff;
            }
    </style>
</head>
<body class="body">
    <header>

        <h1></h1>
        <nav class="desplegable">
            <a></a>
        </nav>
    </header>
    <section class="card" id="tareaAgregar">
        <label for="titulo">Título de la tarea:</label>
        <input type="text" name="titulo" id="titulo" placeholder="Título de la tarea" required="required">
        <label for="descripción">Descripción de la tarea:</label>
        <input type="text" name="descripción" id="descripción" placeholder="Descripción de la tarea" required="required">
        <label for="Encargado">Encargado:</label>
        <input type="text" name="Encargado" id="encargado" placeholder="Nombre del encargado" required="required">
        <div class="buttons">
            <button id="btnCancelar">Cancelar</button>
            <!-- <button class="eliminar">Eliminar</button> -->
            <button id="btnAgregar">Agregar</button>

        </div>
    </section>
    <main style="display:none;" id="vistaTareas">

        <div class="kanban">
            <div class="column" id="todo" ondrop="drop(event)" ondragover="allowDrop(event)">
                <h3>Pendiente</h3>
            </div>
            <div class="column" id="inprogress" ondrop="drop(event)" ondragover="allowDrop(event)">
                <h3>En progreso</h3>
            </div>
            <div class="column" id="done" ondrop="drop(event)" ondragover="allowDrop(event)">
                <h3>Completado</h3>
            </div>
        </div>
        <a href="#" class="add" id="agregar">+</a>
    </main>
    <script>
        const agregarTarea = document.getElementById("tareaAgregar");
        const vistaTareas = document.getElementById("vistaTareas");
        const btnAgregar = document.getElementById("btnAgregar");
        const agregar = document.getElementById("agregar");
        const btnCancelar = document.getElementById("btnCancelar");
        const todoColumn = document.getElementById("todo");
        const inProgressColumn = document.getElementById("inprogress");
        const doneColumn = document.getElementById("done");
        let tareasExistentes = [];
    

        btnAgregar.addEventListener("click", async function () {
            const titulo = document.getElementById("titulo").value.trim();
            const descripcion = document.getElementById("descripción").value.trim();
            const encargado = document.getElementById("encargado").value.trim();

            // Validar que todos los campos estén llenos
            if (!titulo || !descripcion || !encargado) {
                alert("Por favor complete todos los campos antes de agregar la tarea.");
                return;
            }

            // Verificar si ya existe una tarea igual
            const tareaExistente = tareasExistentes.find(t => t.Titulo === titulo);
            if (tareaExistente) {
                alert("La tarea ya existe.");
                return;
            }

            const fechaCreacion = new Date().toISOString();
            const taskId = `${Math.random().toString(36).substring(2, 10)}`; // ID único
            const taskData = {
                Id: taskId,
                Titulo: titulo,
                Descrip: descripcion,
                Encargado: encargado,
                FechaCreacion: fechaCreacion
            };

            try {
                const response = await fetch('/kanban/tarearesibida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    tareasExistentes.push(taskData);
                    agregarTarea.style.display = "none";
                    vistaTareas.style.display = "block";

                    const task = document.createElement("div");
                    task.className = "task";
                    task.id = taskId;
                    task.draggable = true;
                    task.ondragstart = drag;
                    task.innerHTML = `
                                                        <h4>${titulo}</h4>
                                                        <h6>${fechaCreacion}</h6>
                                                        <p>${descripcion}</p>
                                                        <p>${encargado}</p>
                                                        <a class="eliminar fa fa-trash" aria-hidden="true"
                                                          onclick="eliminarTarea('${taskId}')"></a>`;
                    document.getElementById("todo").appendChild(task);
                }
            } catch (error) {
                console.error('Error al agregar tarea:', error);
            }
        });
        agregar.addEventListener("click", function () {
            vistaTareas.style.display = "none";
            agregarTarea.style.display = "grid";
            document.getElementById("titulo").value = "";
            document.getElementById("descripción").value = "";
            document.getElementById("encargado").value = "";

        });
        function allowDrop(event) {
            event.preventDefault();
        }
        function drag(event) {
            event.dataTransfer.setData("text/plain", event.target.id);
        }
        function drop(event) {
            event.preventDefault();
            const data = event.dataTransfer.getData("text");
            const taskElement = document.getElementById(data);

            if (!taskElement) return;

            const sourceColumnId = taskElement.parentElement.id;
            const targetColumnId = event.target.id;

            if (sourceColumnId === "inprogress" && targetColumnId === "todo") {
                alert("No puedes mover una tarea en progreso a pendiente.");
                return;
            }

            if (sourceColumnId === "done" && targetColumnId === "inprogress") {

                event.preventDefault();
                return;
            }

            if (["todo", "inprogress", "done"].includes(targetColumnId)) {
                event.target.appendChild(taskElement);

                if (targetColumnId === "todo") {
                    tareapendiente(data);
                } else if (targetColumnId === "inprogress") {
                    tareaEnProgreso(data);
                } else if (targetColumnId === "done") {
                    tareaTerminada(data);
                }
            }
        }
        async function tareapendiente(taskId) {
            const taskElement = document.getElementById(taskId);
            if (taskElement) {
                const taskData = {
                    Id: taskId,
                    Titulo: taskElement.querySelector("h4").innerText,
                    Descrip: taskElement.querySelector("p").innerText,
                    Encargado: taskElement.querySelector("p:nth-child(4)").innerText,
                    FechaCreacion: taskElement.querySelector("h6").innerText,
                    Estado: 0
                };
                try {
                    const response = await fetch('/kanban/pendiente', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(taskData)
                    });

                } catch (error) {
                    console.error('Error al mover tarea:', error);
                }
            }
        }
        async function tareaEnProgreso(taskId) {
            const taskElement = document.getElementById(taskId);
            if (taskElement) {
                const taskData = {
                    Id: taskId,
                    Titulo: taskElement.querySelector("h4").innerText,
                    Descrip: taskElement.querySelector("p").innerText,
                    Encargado: taskElement.querySelector("p:nth-child(4)").innerText,
                    FechaCreacion: taskElement.querySelector("h6").innerText,
                    Estado: 1
                };
                try {
                    const response = await fetch('/kanban/enprogreso', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(taskData)
                    });

                } catch (error) {
                    console.error('Error al mover tarea:', error);
                }
            }
        }
        async function tareaTerminada(taskId) {
            const taskElement = document.getElementById(taskId);
            if (taskElement) {
                const taskData = {
                    Id: taskId,
                    Titulo: taskElement.querySelector("h4").innerText,
                    Descrip: taskElement.querySelector("p").innerText,
                    Encargado: taskElement.querySelector("p:nth-child(4)").innerText,
                    FechaCreacion: taskElement.querySelector("h6").innerText,
                    Estado: 2
                };
                try {
                    const response = await fetch('/kanban/terminada', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(taskData)
                    });

                } catch (error) {
                    console.error('Error al mover tarea:', error);
                }
            }
        }
        async function eliminarTarea(taskId) {
            const taskElement = document.getElementById(taskId);
            const confirmar = confirm('¿Desea eliminar la tarea?');
            if (!confirmar) return;
            if (taskElement) {
                try {
                    const response = await fetch('/kanban/eliminar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ Id: taskId })
                    });
                    if (response.ok) {
                        taskElement.remove();
                    }
                } catch (error) {
                    console.error('Error al eliminar tarea:', error);
                }
            }
        }
        btnCancelar.addEventListener("click", function () {
            vistaTareas.style.display = "block";
            agregarTarea.style.display = "none";

        });
        var datosJS = "http://localhost:19800/kanban/Tareas";
        console.log(datosJS);
        async function cargarTareas() {
            try {
                const response = await fetch('/kanban/Tareas');
                if (!response.ok) {
                    console.error(`Error HTTP: ${response.status} ${response.statusText}`);
                    return;
                }

                const data = await response.json();
                console.log("Tareas recibidas del servidor:", data);
                const fechaCreacion = new Date().toISOString();

                if (data.Tareas && Array.isArray(data.Tareas)) {
                    data.Tareas.forEach(async (tarea) => {
                        const task = document.createElement("div");
                        task.className = "task";
                        task.id = `task-${tarea.Id}`;
                        task.draggable = true;
                        task.ondragstart = drag;
                       
                            let taskContent = `
                                <h4>${tarea.Titulo}</h4>
                                <h6>${fechaCreacion}</h6>
                                <p>${tarea.Descrip}</p>
                                <p>${tarea.Encargado}</p>
                                <p style="font-size: 0.7rem; color: #666;">IP: ${tarea.idUsuario || 'unknown'}</p>
                                <input type="hidden" id="${tarea.Id}" value="${tarea.Titulo}" style="display:none;">
                                <a class="eliminar fa fa-trash" aria-hidden="true" onclick="eliminarTarea('${tarea.Id}')"></a>`;
                         
                        
                            
                        
                        // Crear el contenido base de la tarea

                        task.innerHTML = taskContent;

                        switch (tarea.Estado) {
                            case 0:
                                document.getElementById('todo').appendChild(task);
                                break;
                            case 1:
                                document.getElementById('inprogress').appendChild(task);
                                break;
                            case 2:
                                document.getElementById('done').appendChild(task);
                                break;
                        }
                    });
                }

                tareasExistentes = data.Tareas || [];

            } catch (error) {
                console.error("Error al cargar tareas:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', cargarTareas);
    </script>

</body>
</html>
